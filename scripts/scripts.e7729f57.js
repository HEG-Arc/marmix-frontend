"use strict";angular.module("marmixApp",["ngAnimate","ngCookies","ngRoute","ngSanitize","ngTouch","ui.bootstrap","smart-table","adf","adf.provider","adf.structures.base"]).config(["$routeProvider","$httpProvider",function(a,b){b.defaults.withCredentials=!0,b.interceptors.push("sessionRecoverer"),a.when("/ticker",{templateUrl:"views/ticker.html",controller:"TickerCtrl"}).when("/clock",{templateUrl:"views/clock.html",controller:"ClockCtrl"}).when("/dashboard/:id",{templateUrl:"views/dashboard.html",controller:"DashboardCtrl",controllerAs:"dashboard"}).otherwise({redirectTo:"/dashboard/0"})}]),angular.module("marmixApp").service("marmixData",["$http","$q","$filter","$timeout","$interval",function(a,b,c,d,e){function f(a){return a.date="R"+a.sim_round+"/D"+c("numberFixedLen")(a.sim_day,2),a.symbol=a.stock.symbol,a}var g=this,h="https://m3.marmix.ch/api/v1";this.holdings={},this.market=[],this.orders=[],this.booksoforders={},this.stocksDetails={},this.clock={},this.getStock=function(a){var b=0;if(g.market)for(b=0;b<g.market.length;b++)if(g.market[b].id===Number(a))return g.market[b]},this.getStockFromSymbol=function(a){for(var b=0;b<g.market.length;b++)if(g.market[b].symbol===a)return g.market[b]},this.getStockPromiseFromSymbol=function(a){function c(b){d(function(){var d=g.getStockFromSymbol(a);d?e.resolve(d):b>1e3?e.reject("timeout"):c(b+100)},b)}var e=b.defer();return c(0),e.promise},this.cancelOrder=function(b){a["delete"](h+"/order/"+b.id+"/").success(function(){g.orders.splice(g.orders.indexOf(b),1)})},this.sendOrder=function(b){a.post(h+"/order/",b).success(function(b){a.get(h+"/orders/"+b.id+"/").success(function(a){g.orders.unshift(a)})})},this.updateHoldings=function(){a.get(h+"/holdings/").success(function(a){g.holdings=a,g.clock=a.clock})},this.updateHoldings(),this.updateOrders=function(){a.get(h+"/orders/").success(function(a){g.orders=a,g.orders=g.orders.map(f)}),a.get(h+"/dividends/").success(function(a){g.dividends=a})},this.updateOrders(),this.updateMarket=function(){a.get(h+"/market/").success(function(a){g.market=a})},this.updateMarket(),this.updateStock=function(b){isNaN(b)||a.get(h+"/stocks/"+b+"/").success(function(a){g.stocksDetails[b]=a;var c=(new Date).getYear()+1900;g.stocksDetails[b].history.filter(function(a){return 0!==a.sim_day}).forEach(function(a){a.date=new Date(c,a.sim_round+1,a.sim_day,0,0,0,0)})})},this.updateStocksDetails=function(){Object.keys(g.stocksDetails).forEach(g.updateStock)},this.updateStockBook=function(b){isNaN(b)||a.get(h+"/book/"+b+"/").success(function(a){g.booksoforders[b]=a})},this.updateBooksofOrders=function(){Object.keys(g.booksoforders).forEach(g.updateStockBook)},this.updateBooksofOrders(),this.findDashboard=function(a){for(var b=a;!b.hasOwnProperty("dashboard");)b=b.$parent;return b.dashboard},e(this.updateHoldings,5e3),e(this.updateOrders,15e3),e(this.updateMarket,5e3),e(this.updateStocksDetails,15e3),e(this.updateBooksofOrders,5e3)}]),angular.module("marmixApp").factory("sessionRecoverer",["$q","$injector","$window",function(a,b,c){var d={responseError:function(d){if(403===d.status||0===d.status){var e=b.get("$http"),f=a.defer(),g=c.prompt("Username?"),h=c.prompt("Password?");if(g&&h)return e.post("https://m3.marmix.ch/api/v1/auth/login/",{username:g,password:h}).then(f.resolve,f.reject),f.promise.then(function(){return e(d.config)})}return a.reject(d)}};return d}]),angular.module("marmixApp").service("dashboardStore",function(){this.create=function(){return{title:"Default",titleTemplateUrl:"views/custom-dashboard-title.html",structure:"9-3",rows:[{columns:[{styleClass:"col-md-9",widgets:[{type:"holdings"},{type:"dividends"},{type:"chart"},{type:"orders"}]},{styleClass:"col-md-3",widgets:[{type:"simclock",config:{sim_round:!0,timestamp:!0}},{type:"orderform",config:{activeSelection:!0}},{type:"bookoforders"}]}]}]}};var a=localStorage.getItem("dashboard");a?this.dashboards=angular.fromJson(a):this.dashboards=[this.create(),{title:"Demo A F",titleTemplateUrl:"views/custom-dashboard-title.html",structure:"12/6-6",rows:[{columns:[{styleClass:"col-md-12",widgets:[{type:"holdings",config:{stock:{AA:!0,FF:!0}}}]}]},{columns:[{styleClass:"col-md-6",widgets:[{type:"chart",config:{symbol:"AA"}},{type:"bookoforders",config:{symbol:"AA",threshold:5}},{type:"orderform",config:{activeSelection:!0}}]},{styleClass:"col-md-6",widgets:[{type:"chart",config:{symbol:"FF"}},{type:"bookoforders",config:{symbol:"FF",threshold:5}}]}]}]}],this.getDashboard=function(a){var b=this.dashboards[a];return b?b=this.dashboards[a]:(b=this.create(),this.saveDashboard(a,b)),b},this.removeDashboard=function(a){this.dashboards.splice(a,1),this.saveDashboards()},this.saveDashboards=function(){localStorage.setItem("dashboard",angular.toJson(this.dashboards))},this.saveDashboard=function(a,b){this.dashboards[a]=b,this.saveDashboards()}}),angular.module("marmixApp").controller("TickerCtrl",["$scope","$http","$interval",function(a,b,c){function d(){b.get("https://m3.marmix.ch/api/v1/tickers/").success(function(b){a.data.tickers=b.results})}a.data={tickers:{}},d();var e=c(d,15e3);a.$on("$destroy",function(){c.cancel(e)})}]),angular.module("marmixApp").controller("ClockCtrl",["$scope","$http","$interval",function(a,b,c){function d(){b.get("https://m3.marmix.ch/api/v1/clock/").success(function(b){a.clock=b})}function e(){b.get("https://m3.marmix.ch/api/v1/market/").success(function(b){a.market=b.results})}e(),d();var f=c(d,2e3),g=c(e,2e3);a.$on("$destroy",function(){c.cancel(f),c.cancel(g)})}]),angular.module("marmixApp").directive("animateOnChange",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.animateOnChange,function(b,d){if(b!==d){var e=b>d?"change-up":"change";a.addClass(c,e).then(function(){a.removeClass(c,e)})}})}}}]),angular.module("marmixApp").directive("amCharts",["$timeout",function(a){return{template:'<div style="height:500px;"></div>',restrict:"E",replace:!0,scope:{chartData:"="},link:function(a,b){a.chartData=a.chartData||[];var c=AmCharts.makeChart(b[0],{type:"stock",theme:"light",pathToImages:"//www.amcharts.com/lib/3/images/",dataSets:[{fieldMappings:[{fromField:"price_open",toField:"open"},{fromField:"price_close",toField:"close"},{fromField:"price_high",toField:"high"},{fromField:"price_low",toField:"low"},{fromField:"volume",toField:"volume"}],color:"#7f8da9",title:"Stock",dataProvider:a.chartData,categoryField:"date"}],panels:[{title:"Value",showCategoryAxis:!1,percentHeight:70,valueAxes:[{id:"v1",dashLength:5}],categoryAxis:{dashLength:5},stockGraphs:[{type:"candlestick",id:"g1",openField:"open",closeField:"close",highField:"high",lowField:"low",valueField:"close",lineColor:"#7f8da9",fillColors:"#7f8da9",negativeLineColor:"#db4c3c",negativeFillColors:"#db4c3c",fillAlphas:1,useDataSetColors:!1,comparable:!1,showBalloon:!0,balloonText:"Open:<b>[[open]]</b><br>Low:<b>[[low]]</b><br>High:<b>[[high]]</b><br>Close:<b>[[close]]</b><br>Sim:<b>R[[sim_round]]/D[[sim_day]]</b><br>",proCandlesticks:!0}],stockLegend:{valueTextRegular:void 0,periodValueTextComparing:"[[percents.value.close]]%"}},{title:"Volume",percentHeight:30,marginTop:1,showCategoryAxis:!0,valueAxes:[{dashLength:5}],categoryAxis:{dashLength:5},stockGraphs:[{valueField:"volume",type:"column",showBalloon:!0,balloonText:"Volume:<b>[[volume]]</b><br>Sim:<b>R[[sim_round]]/D[[sim_day]]</b><br>",fillAlphas:1}],stockLegend:{markerType:"none",markerSize:0,labelText:"",periodValueTextRegular:"[[value.close]]"}}],chartScrollbarSettings:{graph:"g1",graphType:"line",usePeriod:"DD"},chartCursorSettings:{valueLineBalloonEnabled:!0,valueLineEnabled:!0}});a.$watch("chartData",function(){c.initHC&&(c.dataSets[0].dataProvider=a.chartData,c.validateData(),c.zoomOut())},!0)}}}]),angular.module("marmixApp").directive("updownClass",function(){return{restrict:"A",link:function(a,b,c){a.$watch(c.updownClass,function(a){a&&(a.toString().indexOf("-")>-1?(b.addClass("down"),b.removeClass("up")):(b.addClass("up"),b.removeClass("down")))})}}}),angular.module("marmixApp").directive("pageSelect",function(){return{restrict:"E",template:'<input type="text" class="select-page" ng-model="inputPage" ng-change="selectPage(inputPage)">',link:function(a){a.$watch("currentPage",function(b){a.inputPage=b})}}}),angular.module("marmixApp").directive("stSelectMultiple",function(){return{restrict:"E",require:"^stTable",scope:{collection:"=",predicate:"@",predicateExpression:"="},templateUrl:"views/stSelectMultiple.html",link:function(a,b,c,d){function e(){a.dropdownLabel=h();var b=g(),c={matchAny:{}};c.matchAny.items=i();var e=c.matchAny.items.length;0===e||e===a.distinctItems.length?c.matchAny.all=!0:c.matchAny.all=!1,d.search(c,b)}function f(){}function g(){var b=a.predicate;return!b&&a.predicateExpression&&(b=a.predicateExpression),b}function h(){var b=a.distinctItems.length,c=i();return b===c.length||0===c.length?"All":1===c.length?c[0]:c.length+" items"}function i(){var b=[];return angular.forEach(a.distinctItems,function(a){a.selected&&b.push(a.value)}),b}function j(b){var c=g(),d=[];angular.forEach(b,function(a){var b=a[c];k(b,d)}),d.sort(function(a,b){return a.value>b.value?1:a.value<b.value?-1:0});var f=i();d.forEach(function(a){a.selected=f.indexOf(a.value)>-1}),a.distinctItems=d,e()}function k(a,b){a&&a.trim().length>0&&!l(b,a)&&b.push({value:a,selected:!0})}function l(a,b){var c=a.find(function(a){return a.value===b});return c}a.dropdownLabel="",a.filterChanged=e,f(),a.$watch("collection",function(){j(a.collection)})}}}),angular.module("marmixApp").directive("stNumberRange",function(){return{restrict:"E",require:"^stTable",scope:{},templateUrl:"views/stNumberRange.html",link:function(a,b,c,d){var e=b.find("input"),f=angular.element(e[0]),g=angular.element(e[1]),h=c.predicate;[f,g].forEach(function(b){b.bind("blur",function(){var b={};a.lower&&(b.lower=a.lower),a.higher&&(b.higher=a.higher),a.$apply(function(){d.search(b,h)})})})}}}),angular.module("marmixApp").filter("startFrom",function(){return function(a,b){return b=+b,a&&a.slice?a.slice(b):a}}),angular.module("marmixApp").filter("numberFixedLen",function(){return function(a,b){var c=parseInt(a,10);if(b=parseInt(b,10),isNaN(c)||isNaN(b))return a;for(c=""+c;c.length<b;)c="0"+c;return c}}),angular.module("marmixApp").filter("customTableFilter",["$filter",function(a){var b=a("filter"),c=function(a,b){return b=(""+b).toLowerCase(),(""+a).toLowerCase().indexOf(b)>-1};return function(a,d){function e(a,b){var d,e,f,g,h=b.before,i=b.after,j=b.lower,k=b.higher;if(angular.isObject(b)){if(b.distinct)return a&&a.toLowerCase()===b.distinct.toLowerCase()?!0:!1;if(b.matchAny){if(b.matchAny.all)return!0;if(!a)return!1;for(var l=0;l<b.matchAny.items.length;l++)if(a.toLowerCase()===b.matchAny.items[l].toLowerCase())return!0;return!1}if(b.before||b.after)try{return h&&(d=b.before,f=new Date(a),g=new Date(d),f>g)?!1:i&&(e=b.after,f=new Date(a),g=new Date(e),g>f)?!1:!0}catch(m){return!1}else if(j||k)return j&&(d=b.lower,a>d)?!1:k&&(e=b.higher,e>a)?!1:!0;return!0}return c(a,b)}var f=b(a,d,e);return f}}]),angular.module("marmixApp").controller("DashboardCtrl",["$scope","$window","$location","$routeParams","dashboardStore",function(a,b,c,d,e){var f=this;this.model=e.getDashboard(d.id),this.currentStock={},this.setCurrentStock=function(a){a?f.currentStock.id=a:delete f.currentStock.id,f.history=[]},this.currentOrder={},this.deleteDashboard=function(){b.confirm("Confirm delete this page?")&&(e.removeDashboard(d.id),c.path("/dashboard/0"))},this.order=function(a,b,c,d){this.currentOrder.stockID=a,this.currentOrder.order_type=b,this.currentOrder.quantity=c,this.currentOrder.price=d},a.$on("adfDashboardChanged",function(a,b,c){e.saveDashboard(d.id,c)})}]),angular.module("marmixApp").controller("NavigationCtrl",["dashboardStore","$location",function(a,b){this.store=a,this.isActive=function(a){return b.path().split("/").pop()===String(a)}}]),angular.module("marmixApp").config(["dashboardProvider",function(a){a.widget("simclock",{title:"Sim Clock",description:"Displays the current simulation round and day",templateUrl:"views/widget_simclock.html",config:{sim_round:!0,timestamp:!0},edit:{templateUrl:"views/widget_edit_simclock.html"},controller:["$scope","marmixData",function(a,b){a.data=b}]})}]),angular.module("marmixApp").config(["dashboardProvider",function(a){a.widget("orders",{title:"Orders",description:"Displays orders",templateUrl:"views/widget_orders.html",edit:{template:" "},controller:["$scope","marmixData",function(a,b){a.data=b}]})}]),angular.module("marmixApp").config(["dashboardProvider",function(a){a.widget("chart",{title:"Chart",description:"Displays chart for a stock",templateUrl:"views/widget_chart.html",controller:["$scope","marmixData","config",function(a,b,c){function d(c){b.stocksDetails[c]={history:[]},b.updateStock(c);var d=b.getStock(c);d&&(a.$parent.model.title=a.$parent.content.title+": "+d.symbol)}a.data=b,a.dashboard=b.findDashboard(a),c.symbol?b.getStockPromiseFromSymbol(c.symbol).then(function(b){a.stockID=b.id,d(a.stockID)}):a.$watch("dashboard.currentStock.id",function(){a.dashboard.currentStock.id&&d(a.dashboard.currentStock.id)})}],edit:{templateUrl:"views/widget_edit_stock_select.html",controller:["$scope","marmixData",function(a,b){a.data=b}]}})}]),angular.module("marmixApp").config(["dashboardProvider",function(a){a.widget("bookoforders",{title:"Book of Orders",description:"Displays the current market orders",templateUrl:"views/widget_bookoforders.html",controller:["$scope","marmixData","config",function(a,b,c){function d(a){for(var b=0;b<a.length;b++)if("MARKET"===a[b].order_type)return b}function e(c){b.booksoforders[c]=[],b.updateStockBook(c);var d=b.getStock(c);d&&(a.$parent.model.title=a.$parent.content.title+": "+d.symbol)}a.data=b,a.dashboard=b.findDashboard(a),a.limitList=function(a){if(c.threshold&&a){var b=d(a),e=Math.max(0,b-c.threshold),f=Math.min(a.length,b+c.threshold);return a.slice(e,f)}return a},c.symbol?b.getStockPromiseFromSymbol(c.symbol).then(function(b){a.stockID=b.id,e(a.stockID)}):a.$watch("dashboard.currentStock.id",function(){a.dashboard.currentStock.id&&e(a.dashboard.currentStock.id)})}],edit:{templateUrl:"views/widget_edit_bookoforders.html",controller:["$scope","marmixData",function(a,b){a.data=b}]}})}]),angular.module("marmixApp").config(["dashboardProvider",function(a){a.widget("dividends",{title:"Dividends",description:"Displays dividends",templateUrl:"views/widget_dividends.html",controller:["$scope","marmixData","config",function(a,b,c){a.data=b,a.stockFilter=function(a){return c.stock&&Object.keys(c.stock).every(function(a){return c.stock[a]})?c.stock.hasOwnProperty(a.stock)?c.stock:!1:!0}}],edit:{templateUrl:"views/widget_holdings_edit.html",controller:["$scope","marmixData",function(a,b){a.data=b}]}})}]),angular.module("marmixApp").config(["dashboardProvider",function(a){a.widget("holdings",{title:"Holdings",description:"Displays current holdings",templateUrl:"views/widget_holdings.html",controller:["$scope","marmixData","config",function(a,b,c){a.data=b,a.stockFilter=function(a){return c.stock&&Object.keys(c.stock).every(function(a){return c.stock[a]})?c.stock.hasOwnProperty(a.symbol)?c.stock:!1:!0},a.dashboard=b.findDashboard(a)}],edit:{templateUrl:"views/widget_holdings_edit.html",controller:["$scope","marmixData",function(a,b){a.data=b}]}})}]),angular.module("marmixApp").config(["dashboardProvider",function(a){a.widget("orderform",{title:"Order Form",description:"Displays an order form to buy/sell",templateUrl:"views/widget_orderform.html",config:{activeSelection:!0},edit:{templateUrl:"views/widget_edit_orderform.html"},controller:["$scope","marmixData","config","$timeout",function(a,b,c,d){a.data=b,a.dashboard=b.findDashboard(a),a.alerts=[],a.closeAlert=function(b){a.alerts.splice(b,1)},a.ok=function(c){var d=angular.copy(a.order);d.stock=b.getStock(d.stock.id),d.order_type=c,b.sendOrder(d),a.alerts.push({type:"warning",msg:"Submitted order: "+d.order_type+" "+d.quantity+" "+d.stock.symbol})},a.reset=function(){a.order={stock:{id:void 0},order_type:void 0,price:null,quantity:void 0}},a.reset(),c.activeSelection&&a.$watch("dashboard.currentOrder",function(){a.dashboard.currentOrder&&(a.order.order_type=a.dashboard.currentOrder.order_type,a.order.stock.id=String(a.dashboard.currentOrder.stockID),a.order.quantity=a.dashboard.currentOrder.quantity,a.order.price=a.dashboard.currentOrder.price,a.updated=!0,d(function(){a.updated=!1},2e3))},!0)}]})}]),angular.module("marmixApp").config(["dashboardProvider",function(a){a.structure("8-4",{rows:[{columns:[{styleClass:"col-md-8",widgets:[]},{styleClass:"col-md-4",widgets:[]}]}]}).structure("9-3",{rows:[{columns:[{styleClass:"col-md-9",widgets:[]},{styleClass:"col-md-3",widgets:[]}]}]})}]);